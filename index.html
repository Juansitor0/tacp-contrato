<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TACP - Contrato 2026 | Login por Nome</title>
    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-color: #0a0b10;
            --card-bg: #161b22;
            --neon-blue: #00d2ff;
            --matrix-green: #00ff41;
            --alert-red: #ff3131;
            --text-gray: #8b949e;
            --text-white: #c9d1d9;
            --warning-yellow: #ffcc00;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-white);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* TELA DE LOGIN */
        #login-screen {
            width: 100%;
            max-width: 400px;
            background: var(--card-bg);
            border: 1px solid var(--neon-blue);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.2);
            text-align: center;
        }

        #login-screen h2 { color: var(--neon-blue); margin-bottom: 20px; letter-spacing: 2px; }

        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 0.7rem; color: var(--text-gray); margin-bottom: 5px; }
        .input-group input, .input-group select {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid #30363d;
            padding: 12px;
            color: white;
            border-radius: 4px;
            font-family: inherit;
        }
        .input-group input:focus { border-color: var(--neon-blue); outline: none; }

        .btn-login {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--matrix-green);
            color: var(--matrix-green);
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: 0.3s;
        }
        .btn-login:hover { background: var(--matrix-green); color: black; }

        /* DASHBOARD */
        #dashboard {
            display: none;
            width: 100%;
            max-width: 800px;
            background: var(--card-bg);
            border: 1px solid var(--neon-blue);
            padding: 20px;
            border-radius: 8px;
            margin: 20px auto;
            flex-direction: column;
            gap: 20px;
        }

        header {
            border-bottom: 2px solid var(--neon-blue);
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 { color: var(--neon-blue); font-size: clamp(1.1rem, 4vw, 1.6rem); margin: 0; text-transform: uppercase; }

        .system-status { font-size: 0.75rem; text-align: right; flex-grow: 1; }
        .status-online { color: var(--matrix-green); }

        .user-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.3);
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid #30363d;
        }

        .btn-logout {
            background: none;
            border: 1px solid var(--alert-red);
            color: var(--alert-red);
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.7rem;
            border-radius: 3px;
        }

        .main-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .main-grid { grid-template-columns: 1.2fr 0.8fr; } }

        .metric-card-graph {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #30363d;
            padding: 15px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chart-container { position: relative; height: 250px; width: 100%; max-width: 350px; }

        .expandable-section { background: rgba(0, 0, 0, 0.3); border: 1px solid #30363d; border-radius: 4px; overflow: hidden; }
        .expandable-header { padding: 12px; background: rgba(0, 0, 0, 0.5); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .expandable-content { max-height: 0; overflow: hidden; transition: 0.3s; }
        .expandable-section.expanded .expandable-content { max-height: 500px; padding: 15px; }

        .status-slider { width: 100%; accent-color: var(--neon-blue); cursor: pointer; margin: 10px 0; }

        .clauses { display: flex; flex-direction: column; gap: 12px; }
        .clause-item {
            background: rgba(255, 255, 255, 0.03);
            border-left: 4px solid var(--neon-blue);
            padding: 15px;
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
        }
        .clause-item.pending-edit { border-left-color: var(--warning-yellow); }
        .clause-checkbox { margin-right: 12px; width: 20px; height: 20px; accent-color: var(--matrix-green); flex-shrink: 0; }
        .clause-content h3 { margin: 0 0 5px 0; font-size: 0.9rem; color: var(--neon-blue); }
        .clause-content p { margin: 0; font-size: 0.8rem; color: var(--text-gray); }

        .edit-badge { background: var(--warning-yellow); color: #000; font-size: 0.6rem; padding: 2px 5px; border-radius: 3px; margin-left: 5px; font-weight: bold; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--card-bg); border: 1px solid var(--neon-blue); width: 100%; max-width: 500px; border-radius: 8px; padding: 20px; max-height: 90vh; overflow-y: auto; }
        
        textarea { width: 100%; height: 100px; background: #000; color: white; border: 1px solid var(--neon-blue); padding: 10px; margin-top: 10px; font-family: inherit; resize: vertical; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .modal-buttons button { flex: 1; padding: 10px; cursor: pointer; border: 1px solid; background: none; font-family: inherit; border-radius: 4px; }
        .btn-save { border-color: var(--matrix-green); color: var(--matrix-green); }
        .btn-cancel { border-color: var(--alert-red); color: var(--alert-red); }

        #confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <canvas id="confetti"></canvas>

    <!-- TELA DE LOGIN -->
    <div id="login-screen">
        <h2>TACP ACCESS</h2>
        <div class="input-group">
            <label>USUÁRIO</label>
            <select id="login-user">
                <option value="juan">Juan</option>
                <option value="mici">Mici</option>
            </select>
        </div>
        <div class="input-group">
            <label>SENHA</label>
            <input type="password" id="login-password" placeholder="••••••••">
        </div>
        <button class="btn-login" onclick="handleLogin()">ENTRAR NO SISTEMA</button>
        <p id="login-error" style="color: var(--alert-red); font-size: 0.7rem; margin-top: 10px; display: none;"></p>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <header>
            <div>
                <h1>Contrato 2026</h1>
                <div style="font-size: 0.6rem; color: var(--text-gray);">STATUS: ENCRYPTED | REAL-TIME</div>
            </div>
            <div class="system-status">
                <div>DISTÂNCIA: <span id="distancia-val" class="status-online">Calculando...</span></div>
                <div>UPTIME: <span id="uptime-val" class="status-online">00:00:00</span></div>
            </div>
        </header>

        <div class="user-info-bar">
            <span>USUÁRIO ATIVO: <span id="display-user" style="color: var(--neon-blue); font-weight: bold;">---</span></span>
            <button class="btn-logout" onclick="handleLogout()">SAIR</button>
        </div>

        <div class="main-grid">
            <div class="metric-card-graph">
                <span style="font-size: 0.6rem; color: var(--text-gray); text-transform: uppercase;">Biometria Emocional</span>
                <div class="chart-container"><canvas id="radarChart"></canvas></div>
            </div>

            <div class="expandable-section" id="expandable-controls">
                <div class="expandable-header"><span>MEUS STATUS</span><span>▼</span></div>
                <div class="expandable-content">
                    <div class="control-group"><label style="font-size: 0.6rem;">FOME</label><input type="range" class="status-slider" data-index="0" min="0" max="100"></div>
                    <div class="control-group"><label style="font-size: 0.6rem;">PACIÊNCIA</label><input type="range" class="status-slider" data-index="1" min="0" max="100"></div>
                    <div class="control-group"><label style="font-size: 0.6rem;">SAUDADES</label><input type="range" class="status-slider" data-index="2" min="0" max="100"></div>
                    <div class="control-group"><label style="font-size: 0.6rem;">FELICIDADE</label><input type="range" class="status-slider" data-index="3" min="0" max="100"></div>
                    <div class="control-group"><label style="font-size: 0.6rem;">TRISTEZA</label><input type="range" class="status-slider" data-index="4" min="0" max="100"></div>
                </div>
            </div>
        </div>

        <div class="clauses" id="clauses-container"></div>

        <div style="text-align: center; margin-top: 20px;">
            <button id="btn-deploy" style="width: 100%; padding: 15px; border: 1px solid var(--neon-blue); background: none; color: var(--neon-blue); font-weight: bold; cursor: pointer;" disabled>ASSINAR CONTRATO</button>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="color: var(--neon-blue); margin-top: 0;"></h3>
            <div id="modal-body" style="font-size: 0.85rem; line-height: 1.5;"></div>
            <div id="modal-action-area"></div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()">FECHAR</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDeXp1gHm2cyd0MPRbyj7NMm0HlnlI9tCE",
            authDomain: "contrato-online.firebaseapp.com",
            databaseURL: "https://contrato-online-default-rtdb.firebaseio.com",
            projectId: "contrato-online",
            storageBucket: "contrato-online.firebasestorage.app",
            messagingSenderId: "707541071284",
            appId: "1:707541071284:web:6bc61a769477e24feeaee1"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        const defaultClauses = {
            1: { title: "CLÁUSULA 1 – DA DISPONIBILIDADE (DOMINGOS E FERIADOS)", content: "Fica estabelecido que o Contratante continuará exercendo suas funções de quebra-galho oficial, incluindo, mas não se limitando a: Idas emergenciais à farmácia para compra de absorventes e outros itens de primeira necessidade, Suporte 24/7 para emergências domésticas aos domingos, Sem direito a reclamação trabalhista." },
            2: { title: "CLÁUSULA 2 – DA CLÁUSULA ANTI-RESCISÃO", content: "Conforme acordado previamente via WhatsApp, a Contratada optou pela opção Você por completa em vez do jogo de panelas. Fica proibida qualquer tentativa de rescisão de contrato (vulgo se separar). Contrato por tempo indeterminado, Sem multa de saída (porque a saída não é uma opção), Irrevogável e sem direito a rollback." },
            3: { title: "CLÁUSULA 3 – DOS HONORÁRIOS E COMPENSAÇÃO (COMBO LAZER)", content: "Para compensar a carga horária do Contratante, a Contratada pagará o salário através do seguinte pacote: Suporte de Paciência em níveis industriais, 01 final de semana por mês para dormir na residência do Contratante, Regime: Zero Segundas Intenções, Maratonar séries/filmes, Alimentação de Contingência: Direito a lanches." },
            4: { title: "CLÁUSULA 4 – DAS PENALIDADES", content: "Violação do Zero Segundas Intenções: Massagem Completa (mínimo 30 minutos) ou arcar com delivery. Abandono do Fazer Nada: Multa de 01 lanche. Multa Rescisória (Jogo de Panelas): 01 Jogo de Panelas de Pressão de cerâmica ou antiaderente de alta qualidade. Recusa de Ida à Farmácia: Perde direito de reclamar." },
            5: { title: "CLÁUSULA 5 – DISPOSIÇÕES GERAIS", content: "O acordo sério será discutido em reunião oficial, que poderá ocorrer de forma presencial ou remota. Pauta: Leitura minuciosa e análise técnica de cada cláusula. Irretratabilidade: A Contratada fica impedida de dar para trás ou apresentar desistência." }
        };

        let state = {
            currentUser: null,
            clauses: JSON.parse(JSON.stringify(defaultClauses)),
            pendingEdits: {},
            checkboxes: {},
            biometria: { juan: [50,80,70,60,100], mici: [40,70,90,50,100] },
            locations: { juan: {lat:0, lon:0}, mici: {lat:0, lon:0} }
        };

        // LOGIN POR NOME
        async function handleLogin() {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            
            // Converte nome simples em email para o Firebase Auth
            const email = `${user}@tacp.com`;

            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (e) {
                try {
                    await auth.createUserWithEmailAndPassword(email, pass);
                } catch (err) {
                    errorEl.innerText = "Erro: " + err.message;
                    errorEl.style.display = 'block';
                }
            }
        }

        function handleLogout() { auth.signOut(); window.location.reload(); }

        auth.onAuthStateChanged(user => {
            if (user) {
                state.currentUser = user.email.split('@')[0];
                document.getElementById('display-user').innerText = state.currentUser.toUpperCase();
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                initDashboard();
            } else {
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
            }
        });

        function initDashboard() {
            db.ref('tacp_contract').on('value', snapshot => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    state.clauses = data.clauses || state.clauses;
                    state.pendingEdits = data.pendingEdits || {};
                    state.checkboxes = data.checkboxes || {};
                    state.locations = data.locations || state.locations;
                    state.biometria = data.biometria || state.biometria;
                    renderClauses();
                    updateChart();
                    atualizarPainelDistancia();
                    updateDeployButton();
                }
            });
            initRadar();
            iniciarRastreamento();
        }

        function renderClauses() {
            const container = document.getElementById('clauses-container');
            container.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const clause = state.clauses[i] || defaultClauses[i];
                const hasEdit = state.pendingEdits[i];
                const div = document.createElement('div');
                div.className = `clause-item ${hasEdit ? 'pending-edit' : ''}`;
                div.innerHTML = `
                    <input type="checkbox" class="clause-checkbox" ${state.checkboxes[i] ? 'checked' : ''} onclick="event.stopPropagation(); toggleCheckbox(${i}, this.checked)">
                    <div class="clause-content" onclick="openModal(${i})">
                        <h3>${clause.title} ${hasEdit ? '<span class="edit-badge">EDIÇÃO PENDENTE</span>' : ''}</h3>
                        <p>${clause.content.substring(0, 80)}...</p>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        window.toggleCheckbox = (i, checked) => { state.checkboxes[i] = checked; saveData(); };

        function saveData() {
            db.ref('tacp_contract').set({
                clauses: state.clauses,
                checkboxes: state.checkboxes,
                pendingEdits: state.pendingEdits,
                locations: state.locations,
                biometria: state.biometria
            });
        }

        // GPS
        function iniciarRastreamento() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    state.locations[state.currentUser] = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    saveData();
                }, null, { enableHighAccuracy: true });
            }
        }

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function atualizarPainelDistancia() {
            const l1 = state.locations.juan;
            const l2 = state.locations.mici;
            if (l1.lat !== 0 && l2.lat !== 0) {
                const d = calcularDistancia(l1.lat, l1.lon, l2.lat, l2.lon);
                document.getElementById('distancia-val').innerText = d < 1 ? (d*1000).toFixed(0)+"m" : d.toFixed(2)+"km";
            }
        }

        // CHART
        let myRadarChart;
        function initRadar() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Fome', 'Paciência', 'Saudades', 'Felicidade', 'Tristeza'],
                    datasets: [
                        { label: 'Juan', data: state.biometria.juan, borderColor: '#00ff41', backgroundColor: 'rgba(0,255,65,0.1)' },
                        { label: 'Mici', data: state.biometria.mici, borderColor: '#00d2ff', backgroundColor: 'rgba(0,210,255,0.1)' }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { grid: {color:'#333'}, ticks: {display:false}, pointLabels: {color:'#8b949e'} } },
                    plugins: { legend: { labels: {color:'#fff', font:{size:10}} } }
                }
            });
        }

        function updateChart() {
            if (myRadarChart) {
                myRadarChart.data.datasets[0].data = state.biometria.juan;
                myRadarChart.data.datasets[1].data = state.biometria.mici;
                myRadarChart.update();
                document.querySelectorAll('.status-slider').forEach((s, i) => s.value = state.biometria[state.currentUser][i]);
            }
        }

        document.querySelectorAll('.status-slider').forEach(s => s.oninput = (e) => {
            state.biometria[state.currentUser][e.target.dataset.index] = parseInt(e.target.value);
            updateChart();
            saveData();
        });

        // MODAL
        window.openModal = (i) => {
            const clause = state.clauses[i] || defaultClauses[i];
            const hasEdit = state.pendingEdits[i];
            document.getElementById('modal-title').innerText = clause.title;
            document.getElementById('modal-body').innerHTML = `<p>${clause.content}</p>`;
            
            const actionArea = document.getElementById('modal-action-area');
            actionArea.innerHTML = '';

            if (state.currentUser === 'mici') {
                actionArea.innerHTML = `
                    <textarea id="edit-textarea" placeholder="Propor nova versão...">${hasEdit || clause.content}</textarea>
                    <button class="btn-save" style="width:100%; margin-top:10px;" onclick="proposeEdit(${i})">SALVAR PROPOSTA</button>
                `;
            } else if (state.currentUser === 'juan' && hasEdit) {
                actionArea.innerHTML = `
                    <div style="background:rgba(255,204,0,0.1); padding:15px; border:1px solid var(--warning-yellow); margin-top:15px;">
                        <p style="color:var(--warning-yellow); font-size:0.8rem;">PROPOSTA DE MICI:</p>
                        <p style="font-style:italic; font-size:0.85rem;">"${hasEdit}"</p>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn-save" onclick="approveEdit(${i})">APROVAR</button>
                            <button class="btn-cancel" onclick="rejectEdit(${i})">REJEITAR</button>
                        </div>
                    </div>
                `;
            }
            document.getElementById('modal').classList.add('active');
        };

        window.closeModal = () => document.getElementById('modal').classList.remove('active');

        window.proposeEdit = (i) => {
            const val = document.getElementById('edit-textarea').value;
            if (val.trim()) { state.pendingEdits[i] = val; saveData(); closeModal(); }
        };
        window.approveEdit = (i) => {
            state.clauses[i].content = state.pendingEdits[i];
            delete state.pendingEdits[i];
            saveData(); closeModal();
        };
        window.rejectEdit = (i) => { delete state.pendingEdits[i]; saveData(); closeModal(); };

        function updateDeployButton() {
            const checked = Object.values(state.checkboxes).filter(v => v).length;
            document.getElementById('btn-deploy').disabled = checked < 5;
        }

        document.querySelector('.expandable-header').onclick = () => document.getElementById('expandable-controls').classList.toggle('expanded');

        let sec = 0; setInterval(() => { sec++; let h=Math.floor(sec/3600).toString().padStart(2,'0'), m=Math.floor((sec%3600)/60).toString().padStart(2,'0'), s=(sec%60).toString().padStart(2,'0'); document.getElementById('uptime-val').innerText = `${h}:${m}:${s}`; }, 1000);

    </script>
</body>
</html>
